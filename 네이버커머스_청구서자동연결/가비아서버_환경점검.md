# 가비아 Rocky Linux 서버 환경 점검 가이드

> 서버: **139.150.11.53** (Rocky Linux)  
> 목적: `order_listener.py` 24시간 구동을 위한 사전 점검

---

## STEP 1. 서버 접속

```bash
ssh root@139.150.11.53
```

---

## STEP 2. OS / Python 버전 확인

```bash
# OS 버전 확인
cat /etc/os-release

# Python 3 버전 확인 (3.10 이상 권장)
python3 --version

# pip 확인
pip3 --version

# python3 경로 확인
which python3
```

> **최소 요구 버전:** Python **3.10+** (타입 힌트 `str | None` 문법 사용)  
> 3.10 미만이면 아래 명령으로 업그레이드:
> ```bash
> dnf install -y python3.11
> alternatives --set python3 /usr/bin/python3.11
> ```

---

## STEP 3. 필수 패키지 설치 확인

```bash
# 패키지 설치 여부 한번에 확인
pip3 show requests bcrypt pybase64

# 없는 경우 설치
pip3 install requests bcrypt pybase64

# 또는 requirements.txt 직접 사용
pip3 install -r /경로/requirements.txt
```

---

## STEP 4. 프록시 → 네이버 API 연결 테스트

```bash
# 가비아 서버 자체에서 네이버 커머스 API 도달 가능한지 확인
curl -v --max-time 10 https://api.commerce.naver.com

# 프록시 포트 3128 열려있는지 확인 (Squid 기본 포트)
ss -tlnp | grep 3128

# 만약 다른 포트 사용 중이라면 Squid 설정 확인
cat /etc/squid/squid.conf | grep http_port
```

---

## STEP 5. 파일 배포

```bash
# 로컬 PC → 서버로 파일 전송 (로컬 PowerShell에서 실행)
scp -r "C:\Users\삼미2\Downloads\sammirack-estimator\네이버커머스_청구서자동연결" root@139.150.11.53:/opt/sammirack/

# 서버에서 디렉토리 확인
ls -la /opt/sammirack/네이버커머스_청구서자동연결/
```

---

## STEP 6. 수동 실행 테스트 (24시간 전 검증)

```bash
cd /opt/sammirack/네이버커머스_청구서자동연결

# 가상환경 사용 권장 (optional)
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# 수동 실행 (정상 동작 확인)
python3 order_listener.py
```

정상 동작 시 아래처럼 출력됨:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  삼미랙 스마트스토어 실시간 주문 리스너 시작
  폴링 주기: 30초
  프록시: 사용 중 (http://139.150.11.53:3128)
  종료하려면 Ctrl+C 를 누르세요.
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[INIT] 기존 주문 목록 초기화 중...
```

---

## STEP 7. systemd 서비스 등록 (24시간 자동 실행)

### 서비스 파일 생성

```bash
cat > /etc/systemd/system/sammirack-listener.service << 'EOF'
[Unit]
Description=삼미랙 스마트스토어 실시간 주문 리스너
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/sammirack/네이버커머스_청구서자동연결
ExecStart=/opt/sammirack/네이버커머스_청구서자동연결/venv/bin/python3 order_listener.py
Restart=always
RestartSec=10
StandardOutput=append:/var/log/sammirack-listener.log
StandardError=append:/var/log/sammirack-listener.log

[Install]
WantedBy=multi-user.target
EOF
```

### 서비스 활성화 및 시작

```bash
# systemd 리로드
systemctl daemon-reload

# 부팅 시 자동 시작 등록
systemctl enable sammirack-listener

# 서비스 시작
systemctl start sammirack-listener

# 상태 확인
systemctl status sammirack-listener
```

---

## STEP 8. 로그 모니터링

```bash
# 실시간 로그 확인 (가장 유용)
tail -f /var/log/sammirack-listener.log

# 최근 100줄
tail -n 100 /var/log/sammirack-listener.log

# 새 주문 발생 내역만 필터링
grep "새 주문 감지" /var/log/sammirack-listener.log

# 저장된 주문 CSV 확인
cat /opt/sammirack/네이버커머스_청구서자동연결/order_logs/orders_$(date +%Y-%m).csv
```

---

## STEP 9. 서비스 관리 명령어 요약

| 명령어 | 설명 |
|--------|------|
| `systemctl start sammirack-listener` | 시작 |
| `systemctl stop sammirack-listener` | 정지 |
| `systemctl restart sammirack-listener` | 재시작 |
| `systemctl status sammirack-listener` | 상태 확인 |
| `journalctl -u sammirack-listener -f` | systemd 저널 실시간 확인 |

---

## 생성되는 파일 구조

```
order_logs/
├── orders_2026-02.csv          ← 월별 누적 CSV (엑셀로 바로 열기 가능)
├── orders_2026-02.json         ← 월별 누적 JSON 배열
└── individual/
    ├── order_20260220_143205_2026022012345678.json
    └── order_20260220_163012_2026022087654321.json
```
